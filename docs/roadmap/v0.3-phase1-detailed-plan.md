# LabFlow v0.3 階段 1 - 推理引擎 MVP 開發計劃

**版本**：v0.3.0-alpha  
**週期**：3–6 個月  
**狀態**：詳細開發計劃 🚀  
**開始日期**：2026-02-14

---

## 📊 當前進度評估

### v0.2.0 現狀（完成基線）

✅ **已完成**：
- 核心檔案管理系統（上傳、去重、搜尋）
- 完整的標籤與結論系統
- JWT 認證與 RBAC 權限系統
- Docker 容器化部署
- Redis 快取層與性能優化
- 50+ 單元 & 集成測試（>80% 覆蓋率）
- SQLAlchemy ORM 架構

### 技術基礎就緒

| 組件 | 狀態 | 備註 |
|------|------|------|
| FastAPI 後端 | ✅ | 已有 20+ 現成 API 端點 |
| SQLAlchemy ORM | ✅ | 支援 SQLite ↔ PostgreSQL 遷移 |
| Docker & Redis | ✅ | 完整部署棧 |
| 單元測試框架 | ✅ | pytest 已配置 >80% 覆蓋 |
| 異常處理機制 | ✅ | 完整的錯誤日誌與審計 |

### 前端基礎

| 層面 | 進度 | 備註 |
|------|------|------|
| React 項目 | ✅ | 可選：新增 ReactFlow 依賴 |
| Ant Design | ✅ | Pro 組件可用 |
| API 集成 | ✅ | fetch 與 axios 已配置 |

---

## 🎯 階段 1 目標與範圍

### 目標

完成推理鏈系統 MVP，實現：
- 視覺化推理鏈編輯與存儲
- 節點執行引擎與結果追蹤
- 腳本庫管理與執行框架
- 檔案自動分類與元數據提取

### 不在本階段的功能

- ❌ 協作功能（評論、版本控制）
- ❌ AI/ML 模型集成
- ❌ 完全雲端同步
- ❌ WebSocket 實時推送
- ❌ 異常偵測系統

---

## 📝 詳細工作分解 (WBS)

### 第 1 週：環境與基礎設計

#### 1.1 開發環境準備 (2 天)
```
任務：
  [ ] 建立 v0.3 分支 (git checkout -b feature/v0.3-reasoning-engine)
  [ ] 更新依賴（新增 Celery、pydantic、sqlalchemy）
  [ ] 更新 requirements.txt
  [ ] 配置開發環境變數
  [ ] 建立測試資料庫
  
文件位置：
  - requirements.txt (更新)
  - .env.example (更新)
  - conftest.py (更新)
```

#### 1.2 數據模型設計 (2 天)
```
任務：
  [ ] 設計 ReasoningChains 表結構
  [ ] 設計 ReasoningNodes 表結構
  [ ] 設計 ReasoningExecutions 表結構
  [ ] 設計 Scripts 表結構
  [ ] 設計 ScriptExecutions 表結構
  [ ] 建立 SQLAlchemy 模型類
  [ ] 添加必要索引
  [ ] 建立資料庫遷移腳本 (Alembic)
  
文件位置：
  - app/models.py (新增 Reasoning* 類)
  - infra/migrations/versions/ (新遷移檔案)
```

#### 1.3 架構設計評審 (1 天)
```
任務：
  [ ] 繪製推理鏈執行流程圖
  [ ] 設計節點類型與配置格式
  [ ] 評估拓撲排序算法選型
  [ ] 確定錯誤處理策略
  [ ] 確定結果緩存策略
```

---

### 第 2–3 週：推理引擎核心 (80 小時)

#### 2.1 節點執行引擎 (3 週)
```
任務：
  [ ] 實現節點類型定義 (NodeType Enum)
  [ ] 實現 ReasoningNode 數據類
  [ ] 實現拓撲排序算法
  [ ] 實現節點執行器框架
  [ ] 實現各節點類型處理器
      - DATA_INPUT 處理器
      - TRANSFORM 處理器
      - CALCULATE 處理器
      - CONDITION 處理器
      - OUTPUT 處理器
  [ ] 實現推理鏈執行引擎
  [ ] 實現結果儲存與追蹤
  [ ] 實現錯誤處理與重試機制
  [ ] 單元測試 >90% 覆蓋

文件位置：
  - app/reasoning_engine.py (新建，500+ 行)
  - app/reasoning_nodes.py (新建，300+ 行)
  - app/reasoning_handlers.py (新建，400+ 行)
  - app/tests/test_reasoning_engine.py (新建)
  - app/tests/test_reasoning_nodes.py (新建)

預期程式碼量：
  - 推理引擎核心：~1,200 行
  - 單元測試：~500 行
```

#### 2.2 數據庫層 (1 週)
```
任務：
  [ ] 建立 ORM 模型與關係
  [ ] 實現推理鏈 CRUD 操作
  [ ] 實現執行紀錄查詢
  [ ] 建立複合索引（chain_id, status, created_at）
  [ ] 單元測試

文件位置：
  - app/services/reasoning_service.py (新建，300+ 行)
  - app/tests/test_reasoning_service.py (新建)
```

---

### 第 4–5 週：後端 API (40 小時)

#### 3.1 推理鏈 API (2 週)
```
任務：
  [ ] POST /reasoning/chains - 建立推理鏈
  [ ] GET /reasoning/chains - 列表查詢
  [ ] GET /reasoning/chains/{id} - 查詢單個
  [ ] PUT /reasoning/chains/{id} - 編輯推理鏈
  [ ] DELETE /reasoning/chains/{id} - 刪除推理鏈
  [ ] POST /reasoning/chains/{id}/execute - 執行推理鏈
  [ ] GET /reasoning/executions/{id} - 查詢執行結果
  [ ] GET /reasoning/chains/{id}/history - 執行歷史
  [ ] 完整的請求驗證 (Pydantic schema)
  [ ] 集成測試

文件位置：
  - app/api/reasoning_routes.py (新建，400+ 行)
  - app/schemas/reasoning_schemas.py (新建，200+ 行)
  - app/tests/test_reasoning_api.py (新建)

API 設計示例：
```

```python
# 建立推理鏈
POST /reasoning/chains
{
  "name": "XRD 相純度分析",
  "description": "計算 XRD 樣品相純度",
  "nodes": [
    {
      "id": "node1",
      "type": "DATA_INPUT",
      "config": {"file_type": "xrd"}
    },
    {
      "id": "node2",
      "type": "CALCULATE",
      "config": {"algorithm": "phase_purity"},
      "inputs": ["node1"]
    },
    {
      "id": "node3",
      "type": "OUTPUT",
      "config": {"format": "json"},
      "inputs": ["node2"]
    }
  ]
}

# 執行推理鏈
POST /reasoning/chains/chain-1/execute
{
  "file_id": "file-uuid-123"
}

# 獲取結果
GET /reasoning/executions/exec-1
{
  "chain_id": "chain-1",
  "status": "completed",
  "results": {
    "node1": {data object},
    "node2": {calculation results},
    "node3": {output}
  }
}
```

---

### 第 6–7 週：腳本庫系統 (50 小時)

#### 4.1 腳本管理後端 (2 週)
```
任務：
  [ ] 設計腳本存儲格式 (Python/JSON 配置)
  [ ] 實現腳本上傳與驗證
  [ ] 實現版本管理機制
  [ ] 實現腳本分類與搜尋
  [ ] POST /scripts/upload - 上傳腳本
  [ ] GET /scripts/ - 列表查詢
  [ ] GET /scripts/{id} - 查詢腳本
  [ ] PUT /scripts/{id} - 編輯腳本
  [ ] DELETE /scripts/{id} - 刪除腳本
  [ ] 完整的參數驗證
  [ ] 集成測試

文件位置：
  - app/services/script_service.py (新建，250+ 行)
  - app/api/scripts_routes.py (新建，300+ 行)
  - app/schemas/script_schemas.py (新建，150+ 行)
  - app/tests/test_scripts_api.py (新建)
```

#### 4.2 沙盒執行框架 (1 週)
```
任務：
  [ ] 設計腳本執行環境 (Python 進程隔離或 Docker)
  [ ] 實現參數注入機制
  [ ] 實現執行超時控制
  [ ] 實現資源限制 (CPU、記憶體)
  [ ] 實現結果捕獲
  [ ] 實現錯誤日誌捕獲
  [ ] POST /scripts/{id}/execute - 執行腳本
  [ ] GET /script-executions/{id} - 查詢執行結果

文件位置：
  - app/services/script_executor.py (新建，400+ 行)
  - app/tests/test_script_executor.py (新建)
```

---

### 第 8–9 週：檔案自動分類 (40 小時)

#### 5.1 命名規則引擎 (1.5 週)
```
任務：
  [ ] 設計規則配置格式 (YAML/JSON)
  [ ] 實現正則表達式匹配
  [ ] 實現檔案類型識別 (XRD/EIS/SEM)
  [ ] 實現元數據提取邏輯
      - 從檔名提取樣品編號
      - 從檔名提取測試日期
      - 從檔名提取儀器類型
  [ ] 實現自動標籤建議
  [ ] 單元測試

文件位置：
  - app/services/file_classifier.py (新建，300+ 行)
  - app/tests/test_file_classifier.py (新建)

規則配置示例 (YAML):
```

```yaml
# config/file_classification_rules.yml
rules:
  xrd:
    pattern: '(\w+)_XRD_(\d{8})'
    type: 'xrd_pattern'
    extract:
      - field: 'sample_id'
        group: 1
      - field: 'test_date'
        group: 2
      - field: 'file_type'
        value: 'XRD'
    tags:
      - 'XRD'
      - 'XRD分析'
  
  eis:
    pattern: '(\w+)_EIS_(\d{8})'
    type: 'eis_spectrum'
    extract:
      - field: 'sample_id'
        group: 1
      - field: 'test_date'
        group: 2
    tags:
      - 'EIS'
      - '電化學'
```

#### 5.2 檔案管理擴展 (1.5 週)
```
任務：
  [ ] POST /files/classify - 批量分類
  [ ] POST /files/{id}/auto-classify - 自動分類
  [ ] GET /files/classifications - 分類結果查詢
  [ ] 自動標籤關聯
  [ ] 自動元數據更新
  [ ] 集成測試
```

---

### 第 10 週：前端開發 (60 小時)

#### 6.1 推理鏈編輯器 (3 天)
```
任務：
  [ ] 安裝 ReactFlow 與相關依賴
  [ ] 建立編輯器頁面框架
  [ ] 實現節點渲染
  [ ] 實現邊 (Edge) 連接
  [ ] 實現參數配置面板
  [ ] 實現儲存功能
  [ ] 實現載入功能
  [ ] 實現驗證 (連接邏輯)
  [ ] UI 美化 (Ant Design)

文件位置：
  - src/pages/ReasoningEditor/
    - index.tsx (主頁面)
    - EditorCanvas.tsx (畫布)
    - NodePanel.tsx (節點配置)
    - ControlPanel.tsx (控制面板)
  - src/components/ReasoningFlow/
    - Node.tsx (節點組件)
    - CustomEdge.tsx (自定義邊)

預期程式碼量：
  - React 組件：~1,500 行
  - CSS/樣式：~300 行
```

#### 6.2 推理鏈模板庫 (2 天)
```
任務：
  [ ] 建立模板庫 UI 頁面
  [ ] 實現模板展示列表
  [ ] 實現模板預覽功能
  [ ] 實現「使用此模板」功能
  [ ] 建立 5–10 個預定義模板
    - XRD 相純度分析
    - EIS 阻抗分析
    - SEM 顆粒度分析
    - 充放電曲線分析
    - 倍率性能評估

文件位置：
  - src/pages/ReasoningLibrary/
  - src/services/template_service.ts
  - src/data/default_templates.ts
```

#### 6.3 腳本庫管理 UI (2 天)
```
任務：
  [ ] 建立腳本管理頁面
  [ ] 實現腳本上傳
  [ ] 實現腳本版本管理 UI
  [ ] 實現腳本執行 UI
  [ ] 實現執行結果展示
  [ ] 實現錯誤日誌查看

文件位置：
  - src/pages/ScriptLibrary/
  - src/components/ScriptUpload/
  - src/components/ExecutionMonitor/
```

#### 6.4 檔案自動分類 UI (1 天)
```
任務：
  [ ] 集成分類按鈕到檔案管理頁面
  [ ] 展示分類結果與自動標籤
  [ ] 實現分類規則預覽
```

---

### 第 11–12 週：測試與優化 (50 小時)

#### 7.1 單元與集成測試 (2.5 週)
```
任務：
  [ ] 推理引擎單元測試 >95% 覆蓋
  [ ] API 集成測試 (每個端點)
  [ ] 場景測試 (複雜推理鏈)
  [ ] 前端單元測試 (React 組件)
  [ ] 端到端測試 (E2E)
  [ ] 性能測試 (執行 100+ 節點鏈)
  [ ] 壓力測試 (並發執行)

文件位置：
  - app/tests/test_reasoning_*.py
  - app/tests/test_scripts_*.py
  - src/__tests__/
  - e2e/reasoning.spec.ts

預期覆蓋率：
  - 後端：>90%
  - 前端：>80%
```

#### 7.2 文檔與部署 (1 週)
```
任務：
  [ ] API 文檔 (Swagger 自動生成)
  [ ] 開發指南編寫
  [ ] 推理鏈使用教程
  [ ] 腳本編寫指南
  [ ] Docker 部署測試
  [ ] GitHub Actions CI/CD 更新
  [ ] 版本標籤 (v0.3.0-beta)
```

---

## 📊 工作量估算（詳細）

| 模塊 | 工作量 | 周期 | 人力 |
|------|--------|------|------|
| 環境與設計 | 20h | 1w | 1 人 |
| 推理引擎核心 | 80h | 2w | 1 人 |
| 後端 API | 40h | 1.5w | 1 人 |
| 腳本庫系統 | 50h | 2w | 1 人 |
| 檔案分類 | 40h | 1.5w | 1 人 |
| 前端開發 | 60h | 1.5w | 1 人 |
| 測試與優化 | 50h | 1.5w | 1 人 |
| **總計** | **340h** | **12w** | **1–2 人** |

> 備註：可並行進行測試與文檔編寫，實際週期可縮短至 8–10 週

---

## 🏆 驗收標準

### 功能驗收

- [ ] 推理鏈編輯器可正常建立、編輯、儲存複雜推理鏈
- [ ] 推理引擎可正確執行各類型節點
- [ ] 執行成功率 >95% (500+ 測試用例)
- [ ] 複雜推理鏈 (10+ 節點) 執行時間 <5s
- [ ] 腳本庫支援 10+ 預定義分析腳本
- [ ] 檔名解析準確率 >90% (100+ 真實檔案測試)
- [ ] 自動標籤建議準確率 >85%

### 品質驗收

- [ ] 單元測試覆蓋率 >90%
- [ ] 集成測試覆蓋率 >85%
- [ ] 代碼靜態檢查 (pylint、mypy) 通過
- [ ] API 文檔完整度 100%
- [ ] 無嚴重 Bug (P0/P1)

### 性能驗收

- [ ] API 響應時間 <200ms (p95)
- [ ] 編輯器交互流暢 (60 FPS)
- [ ] 推理鏈執行記憶體使用 <500MB
- [ ] 支援 1000+ 推理鏈儲存

---

## 📅 時間表 (12 週計劃)

```
第 1 週：環境 + 設計 (20h)
├─ 2/14-2/20：開發環境、數據設計、架構評審

第 2–3 週：推理引擎核心 (80h)
├─ 2/21-3/6：節點執行、拓撲排序、處理器實現

第 4–5 週：後端 API (40h)
├─ 3/7-3/20：推理鏈 API、驗證、集成測試

第 6–7 週：腳本庫系統 (50h)
├─ 3/21-4/3：腳本管理、沙盒執行、測試

第 8–9 週：檔案分類 (40h)
├─ 4/4-4/17：命名解析、類型識別、元數據提取

第 10 週：前端開發 (60h)
├─ 4/18-5/1：編輯器、模板庫、腳本 UI

第 11–12 週：測試 & 優化 (50h)
├─ 5/2-5/15：單元測試、E2E、文檔、部署

🎉 v0.3.0-beta 發佈 (預計 5 月中旬)
```

---

## 🔄 Git 分支策略

```
main (生產分支)
  ↑
release/v0.3.0-beta (發佈分支)
  ↑
develop (開發主分支)
  ↑
├─ feature/v0.3-reasoning-engine (主開發分支)
│  ├─ feature/reasoning-core (推理引擎)
│  ├─ feature/reasoning-api (API)
│  ├─ feature/scripts-system (腳本庫)
│  ├─ feature/file-classifier (檔案分類)
│  ├─ feature/reasoning-ui (前端)
│  └─ feature/testing (測試)
```

---

## 📋 每週檢查清單

### 每週五會議

```
第 1 週
  [ ] 環境配置完成 ✓
  [ ] 數據表設計通過評審 ✓
  [ ] 架構文檔完成 ✓

第 2–3 週
  [ ] 核心引擎實現 50% ✓
  [ ] 單元測試 >80% ✓
  [ ] 無阻塞性 Bug ✓

第 4–5 週
  [ ] API 實現 100% ✓
  [ ] 集成測試通過 ✓
  [ ] 文檔同步更新 ✓

... (持續追蹤)
```

---

## 🚀 推進策略

### 快速迭代

每週小發佈（alpha/beta）：
- 週一：計劃
- 週二–四：開發 & 測試
- 週五：評審 & 合併

### 團隊協作

```
1 人全職開發模式：
  - 優先完成後端核心 (引擎 + API) → 2–3 週
  - 平行開發前端 → 同時進行
  - 密集測試與優化 → 最後 1 週

2 人開發模式 (推薦)：
  - 開發者 1：推理引擎 + 後端 API
  - 開發者 2：腳本系統 + 前端 UI
  - 交叉測試與集成
```

---

## ⚠️ 風險與緩解

| 風險 | 概率 | 影響 | 緩解措施 |
|------|------|------|---------|
| 推理引擎複雜度過高 | 中 | 高 | 早期 POC、迭代設計 |
| 前端 ReactFlow 學習曲線 | 低 | 中 | 提前調研、示例代碼 |
| 腳本沙盒執行安全問題 | 低 | 高 | Docker 隔離、資源限制 |
| 性能瓶頸 (100+ 節點) | 低 | 中 | 早期性能測試、優化 |

---

## 🎓 預期產出

### 代碼產出
- 推理引擎核心：~1,200 行
- 後端 API & 服務：~1,500 行
- 腳本系統：~650 行
- 檔案分類系統：~300 行
- 前端組件：~1,500 行
- 單元測試：~1,000 行
- **總計**：~6,750 行

### 文檔產出
- API 文檔（Swagger 自動生成）
- 開發者指南
- 推理鏈使用教程
- 腳本編寫指南

### 數據產出
- 10+ 預定義模板
- 5+ 示例分析腳本
- 分類規則配置

---

## 📞 溝通與反饋

### 每週會議

**時間**：每週五 14:00  
**主題**：進度評審、風險討論、下週計劃  
**參與者**：開發者、架構師、測試

### 進度追蹤

- **GitHub Issues**：分解為 50+ 個任務
- **GitHub Projects**：看板管理
- **Git 提交日誌**：追蹤變更

---

**下一步行動**：
1. [ ] 本週建立 v0.3 分支
2. [ ] 設計推理鏈數據表
3. [ ] 安裝必要依賴
4. [ ] 開始第 1 週任務

---

**文檔版本**：v1.0  
**最後更新**：2026-02-14  
**狀態**：就緒開發 🚀

